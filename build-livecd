#!/bin/bash

[[ -z "$1" ]] && echo "Usage: $0 fdi-name.ks [RELEASE_NUMBER]" && exit 1

VERSION=$(git describe --abbrev=0 --tags)
RELEASE=$(date +%Y%m%d).${2:-1}
KS_INSTALL=fdi-install.ks
KS_TARGET=fdi-image.ks
OVERLAY="/etc/systemd/system/discover-host.service
  /etc/systemd/system/nm-prepare.service
  /etc/rc.d/rc.local
  /usr/share/fdi/VERSION
  /usr/share/fdi/RELEASE
  /usr/share/fdi/facts/discovery-facts.rb
  /usr/bin/find-missing-libs
  /usr/bin/find-largest-rpms
  /usr/bin/discovery-debug
  /usr/bin/nm-prepare
  /usr/bin/discover-host"

# prepare version and release files
echo "$VERSION" > root/usr/share/fdi/VERSION
echo "$RELEASE" > root/usr/share/fdi/RELEASE

# generate install overlay
echo "# <generated by build-livecd>" > $KS_INSTALL
for FILE in $OVERLAY; do
cat >> $KS_INSTALL <<EOF
%post
mkdir -p \$(dirname $FILE)
cat > $FILE <<'CODE'
$(cat root$FILE)
CODE
%end
EOF
done
cat >> $KS_INSTALL <<KS
%post
chmod +x \
  /etc/rc.d/rc.local \
  /usr/bin/discover-host \
  /usr/bin/find-missing-libs \
  /usr/bin/find-largest-rpms \
  /usr/bin/discovery-debug \
  /usr/bin/nm-prepare
%end
KS
echo "# </generated by build-livecd>" >> $KS_INSTALL

# prepare result kickstart
ksflatten "$1" -o $KS_TARGET

echo "Now run as root ./build-live-root or submit $KS_TARGET into koji"
