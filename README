

  _____
 |  ___|__  _ __ ___ _ __ ___   __ _ _ __
 | |_ / _ \| '__/ _ \ '_ ` _ \ / _` | '_ \
 |  _| (_) | | |  __/ | | | | | (_| | | | |
 |_|__\___/|_|  \___|_| |_| |_|\__,_|_| |_|
   |  _ \(_)___  ___ _____   _____ _ __ _   _
   | | | | / __|/ __/ _ \ \ / / _ \ '__| | | |
   | |_| | \__ \ (_| (_) \ V /  __/ |  | |_| |
   |____/|_|___/\___\___/ \_/ \___|_|   \__, |
                                        |___/


Foreman Discovery Image
=======================

Building
--------

To prepare CentOS 7 build:

  $ ./build-livecd fdi-centos7.ks

To prepare Fedora 19 build:

  $ ./build-livecd fdi-fedora19.ks

To build the image (make sure you have at least 1 GB free space in /tmp):

  $ sudo ./build-livecd-root

Copy the resulting tarball to the TFTP boot directory:

  $ tar xvf fdi-image-*.tar -C /var/tftproot/boot

And visit https://github.com/theforeman/foreman_discovery for more information
about how to configure Foreman and how to use the plugin.

Additional facts
----------------

Some extra facts are reported in addition to the standard ones reported by Facter:

  FACTERLIB=/usr/share/fdi/facts/ facter | grep discovery
  discovery_bootif => 52:54:00:94:9e:52
  discovery_bootip => 192.168.122.51

discovery_bootif - MAC of the interface it was booted from
discovery_bootip - IP of the interface it was booted from

Troubleshooting
---------------

The first virtual console is reserved for logs, all systemd logging is shown
there. Particulary useful system logs are tagged with:

  * discover-host - initial facts upload
  * foreman-discovery - facts refresh, reboot remote commands
  * nm-prepare - boot script which pre-configures NetworkManager
  * NetworkManager - networking information

The root account and ssh access are disabled by default, but you can enable ssh
and set root password using the following kernel command line options:

  fdi.ssh=1 fdi.rootpw=redhat

You can use tty2 console (or higher) to login as well.

Downstream
----------

This repostirory is downstream friendly for koji. The generated fdi-image.ks
kickstart file is self-containing. First of all, run the initial script and
provide empty base kickstart without any repositories (they will be added via
koji:

  $ ./build-livecd fdi-empty.ks

Then simply build the image from kickstart called fdi-image.ks:

  koji spin-livecd \
    fdi-image-rhel_7_0 \
    $(cat root/usr/share/fdi/VERSION) \
    --release $(cat root/usr/share/fdi/RELEASE) \
    --repo=http://my.repo/1 \
    --scratch \
    my-tag-image
    x86_64 \
    fdi-image.ks

Then extract the kernel and initial RAM disk:

  mv fdi-image-rhel_7_0-1.9.90-20141022.1.iso fdi.iso
  livecd-iso-to-pxeboot fdi.iso
